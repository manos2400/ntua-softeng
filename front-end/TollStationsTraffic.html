<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toll Traffic by Operator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .result {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .chart {
            margin-top: 20px;
        }
        .error {
            color: red;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Traffic by Operator</h1>

    <!-- Form to Input Parameters -->
    <div class="form-section">
        <label for="stationOpID">Operator ID:</label>
        <input type="text" id="stationOpID" placeholder="e.g., NAO">
        <br>
        <label for="date_from">Date From (YYYYMMDD):</label>
        <input type="text" id="date_from" placeholder="e.g., 20240101">
        <br>
        <label for="date_to">Date To (YYYYMMDD):</label>
        <input type="text" id="date_to" placeholder="e.g., 20240107">
        <br>
        <button id="fetchButton">Get Traffic</button>
    </div>

    <!-- Results Section -->
    <div id="result" class="result">
        <h2>Results</h2>
        <p id="traffic-summary"></p>
        <canvas id="trafficChart" class="chart"></canvas>
    </div>

    <script>
        document.getElementById('fetchButton').addEventListener('click', async () => {
            const stationOpID = document.getElementById('stationOpID').value;
            const date_from = document.getElementById('date_from').value;
            const date_to = document.getElementById('date_to').value;

            const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzMzNjkzNTgyLCJleHAiOjE3MzM2OTcxODJ9.65U7tHzjWm1FLUcIVFem5ZQSLn5Q98xRRmwg-ER04hY' // Replace YOUR_TOKEN with a valid token

            const resultText = document.getElementById('traffic-summary');
            const chartCanvas = document.getElementById('trafficChart');
            const chartContext = chartCanvas.getContext('2d');
            resultText.textContent = ''; // Clear previous results
            chartCanvas.style.display = 'none'; // Hide chart initially

            // Input validation
            if (!stationOpID || !date_from || !date_to) {
                resultText.textContent = 'Please fill all fields.';
                resultText.classList.add('error');
                return;
            }

            try {
                // Fetch toll stations for the given operator
                const responseStations = await fetch(`http://localhost:9115/api/TollStations/${stationOpID}`, {
                    headers: {
                        'x-observatory-auth': token,
                    },
                });

                if (!responseStations.ok) {
                    throw new Error(`HTTP error! Status: ${responseStations.status} API URL: http://localhost:9115/api/getTollStations/${stationOpID} `);
                }

                const tollStations = await responseStations.json();
                console.log("Toll Stations:", tollStations);

                const stationData = [];

                // Fetch data for each toll station owned by the operator
                for (const tollStation of tollStations) {
                    const response = await fetch(`http://localhost:9115/api/tollStationPasses/${tollStation.id}/${date_from}/${date_to}`, {
                        headers: {
                            'x-observatory-auth': token,
                        },
                    });

                    if (!response.ok) {
                        console.warn(`Failed to fetch data for toll station ${tollStation.id}: HTTP ${response.status}`);
                        continue;
                    }

                    const data = await response.json();
                    stationData.push({ stationID: tollStation.id, n_passes: data.n_passes });
                }

                console.log("Traffic Data:", stationData);

                // Check if any data was fetched
                if (stationData.length === 0) {
                    resultText.textContent = 'No traffic data found for the given operator and date range.';
                    resultText.classList.add('error');
                    return;
                }

                // Display results
                const totalPasses = stationData.reduce((sum, station) => sum + station.n_passes, 0);
                resultText.textContent = `Total Passes for Operator ${stationOpID}: ${totalPasses}`;
                resultText.classList.remove('error');

                // Create bar chart
                chartCanvas.style.display = 'block';
                new Chart(chartContext, {
                    type: 'bar',
                    data: {
                        labels: stationData.map(station => station.stationID),
                        datasets: [{
                            label: 'Number of Passes',
                            data: stationData.map(station => station.n_passes),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                        }],
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                    },
                });
            } catch (error) {
                console.error("Error fetching data:", error);
                resultText.textContent = `Error: ${error.message}`;
                resultText.classList.add('error');
            }
        });
    </script>
</body>
</html>
